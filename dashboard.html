<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Portfolio Analytics - Private</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/professional.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .dashboard-header h1 {
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        .dashboard-header p {
            color: var(--text-secondary);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .visits-table-wrapper {
            overflow-x: auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
        }
        .visits-table {
            width: 100%;
            border-collapse: collapse;
        }
        .visits-table th,
        .visits-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .visits-table th {
            color: var(--accent);
            font-weight: 600;
        }
        .visits-table tr:hover {
            background: var(--accent-dim);
        }
        .access-denied {
            text-align: center;
            padding: 4rem 2rem;
        }
        .access-denied h2 {
            color: #f87171;
            margin-bottom: 1rem;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--accent);
            text-decoration: none;
            transition: var(--transition);
        }
        .back-link:hover {
            color: var(--accent-hover);
        }
        .refresh-btn {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-left: 1rem;
            transition: var(--transition);
        }
        .refresh-btn:hover {
            background: var(--accent-dim);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Portfolio</a>
        
        <div id="access-denied" class="access-denied" style="display: none;">
            <h2><i class="fas fa-lock"></i> Access Denied</h2>
            <p>Invalid or missing access key. Use the correct URL to view analytics.</p>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="dashboard-header">
                <h1><i class="fas fa-chart-bar"></i> Portfolio Visitor Analytics</h1>
                <p>Private dashboard — who's visiting your portfolio</p>
                <button class="refresh-btn" onclick="loadVisits()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="stat-total">0</div>
                    <div class="label">Total Visits</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-today">0</div>
                    <div class="label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-unique-ips">0</div>
                    <div class="label">Unique IPs</div>
                </div>
            </div>

            <div class="visits-table-wrapper">
                <table class="visits-table">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>IP Address</th>
                            <th>Location</th>
                            <th>Browser</th>
                            <th>OS</th>
                            <th>User</th>
                            <th>Page</th>
                            <th>Referrer</th>
                        </tr>
                    </thead>
                    <tbody id="visits-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading...</p>
        </div>
    </div>

    <script src="assets/js/visitor-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            var config = window.VISITOR_CONFIG || {};
            var params = new URLSearchParams(window.location.search);
            var key = params.get('key');
            var validKey = config.dashboardSecret && config.dashboardSecret !== 'CHANGE_THIS_TO_A_RANDOM_STRING';

            function showDenied() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'none';
                document.getElementById('access-denied').style.display = 'block';
            }

            function loadVisits() {
                if (!config.supabaseUrl || !config.supabaseKey) {
                    document.getElementById('visits-tbody').innerHTML = '<tr><td colspan="8">Configure Supabase in visitor-config.js</td></tr>';
                    return;
                }

                var supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
                supabase.from('portfolio_visits')
                    .select('*')
                    .order('visited_at', { ascending: false })
                    .limit(100)
                    .then(function(result) {
                        var visits = result.data || [];
                        var error = result.error;

                        if (error) {
                            document.getElementById('visits-tbody').innerHTML = '<tr><td colspan="8">Error: ' + (error.message || 'Failed to load data') + '</td></tr>';
                            return;
                        }

                        var today = new Date().toDateString();
                        var todayCount = visits.filter(function(v) {
                            return new Date(v.visited_at).toDateString() === today;
                        }).length;
                        var ips = {};
                        visits.forEach(function(v) {
                            if (v.ip_address) ips[v.ip_address] = true;
                        });

                        document.getElementById('stat-total').textContent = visits.length;
                        document.getElementById('stat-today').textContent = todayCount;
                        document.getElementById('stat-unique-ips').textContent = Object.keys(ips).length;

                        var tbody = document.getElementById('visits-tbody');
                        tbody.innerHTML = visits.length === 0
                            ? '<tr><td colspan="8">No visits recorded yet.</td></tr>'
                            : visits.map(function(v) {
                                var date = new Date(v.visited_at);
                                var dateStr = date.toLocaleString();
                                var loc = v.location_display;
                                if (!loc && (v.location_city || v.location_country)) {
                                    loc = [v.location_city, v.location_county, v.location_region, v.location_country].filter(Boolean).join(', ');
                                }
                                if (loc && v.location_lat != null && v.location_lon != null && !isNaN(parseFloat(v.location_lat)) && !isNaN(parseFloat(v.location_lon))) {
                                    loc += ' <small style="color:var(--text-secondary)">(' + parseFloat(v.location_lat).toFixed(4) + ', ' + parseFloat(v.location_lon).toFixed(4) + ')</small>';
                                }
                                var location = loc || v.timezone || '-';
                                var browser = v.browser_name || '-';
                                var os = v.os_name || '-';
                                var user = v.user_name || '—';
                                var ref = v.referrer ? (v.referrer.length > 35 ? v.referrer.substring(0, 35) + '...' : v.referrer) : '-';
                                return '<tr>' +
                                    '<td>' + dateStr + '</td>' +
                                    '<td>' + (v.ip_address || '-') + '</td>' +
                                    '<td>' + location + '</td>' +
                                    '<td>' + browser + '</td>' +
                                    '<td>' + os + '</td>' +
                                    '<td>' + user + '</td>' +
                                    '<td>' + (v.page_path || '/') + '</td>' +
                                    '<td title="' + (v.referrer || '') + '">' + ref + '</td>' +
                                    '</tr>';
                            }).join('');
                    })
                    .catch(function(err) {
                        document.getElementById('visits-tbody').innerHTML = '<tr><td colspan="8">Error: ' + (err.message || 'Failed to load visits') + '</td></tr>';
                    });
            }

            function showDashboard() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('access-denied').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                loadVisits();
            }

            if (!validKey || key !== config.dashboardSecret) {
                showDenied();
                return;
            }

            showDashboard();
            window.loadVisits = loadVisits;
        })();
    </script>
</body>
</html>
